server {
        listen              80;

        server_name mashuai2.s.etao.com;
        
        #log_format          sformat        '$remote_addr $request_time_usec $remote_user [$time_local] '
        #                                    '"$request_method http://$host$request_uri" $status $body_bytes_sent '
        #                                    '"$http_referer" "$http_user_agent"';

        access_log          "pipe:/home/admin/cronolog/sbin/cronolog /home/admin/web/logs/mary/%Y/%m/%d/access-%Y-%m-%d_%H.log" sformat;
        log_not_found       off;

        root                /home/admin/web/htdocs/leapfrog_mashuai2/Setlive;

        error_page          400 403 404 405 408 410 411 412 413 414 415  500 502 503 504 506  /;

        expires_by_types 3y image/gif image/jpeg image/jpg image/png image/x-icon text/css application/x-shockwave-flash;
        
      
        rewrite  ^/search$ /search.php last;
        rewrite  ^/rss$ /rss.php last;
	    rewrite  ^/index.(php|html)$ http://www.etao.com last;
	    rewrite  ^/item/(\d+).html$ /search.php?v=product&p=detail&epid=$1 last;
        rewrite  ^/cp/(.*).html$  /product_cp/detail.php?q=$1 last;
        rewrite  ^/daily/(.*)$ /search.php?sdate=$1 last;        
   
        rewrite  ^/key/(.*)_$ http://s.etao.com last; 
        rewrite  ^/key/q_(.*)\_cat\_(\d+)\_ppath\_(.*)$  /search.php?q=$1&cat=$2&ppath=$3 last;
        rewrite  ^/key/q_(.*)\_cat\_(\d+)$  /search.php?q=$1&cat=$2 last;
        rewrite  ^/key/q_(.*)\_ppath\_(.*)$  /search.php?q=$1&ppath=$2 last;
        rewrite  ^/key/q_(.*)$  /search.php?q=$1 last;
	    rewrite  ^/$ http://www.etao.com permanent;

        set $php 1;

        if ($request_uri = '/status.html') {
            set $php  0;
        }

        if ($request_uri = '/robots.txt') {
            set $php  0;
        }

        if ($php) {
            rewrite ^/(.*).html$ /$1.php last;
        }

        #rewrite ^/product/(.*).html$ /product/$1.php last;
        #rewrite ^/js/\d+/(.*\.js) /combine.php?type=js&files=$1 last;
        #rewrite ^/css/\d+/(.*\.css) /combine.php?type=css&files=$1 last;


        location = /status.html {
            root /home/admin/web/htdocs;
        }

        location = /robots.txt {
            root /home/admin/web/htdocs;
        }

        location            = /nginx_status {
            stub_status     on;
            access_log     off;
            allow 10.234.7.66;
            allow 127.0.0.1;
            deny all;
        }

        location  = /fpm_status {
                include fastcgi_params;
                fastcgi_pass 127.0.0.1:9090;
                fastcgi_param SCRIPT_FILENAME $fastcgi_script_name;
                access_log     off;
                allow 10.234.7.66;
                allow 127.0.0.1;
                deny all;
        }
        
        location ~* /sitemap(.*).xml {
            charset UTF-8;
            #add_header  Content-Type  "text/xml";
            #add_header  Content-Encoding  gzip;
            #gzip off;
            root /home/admin/web/htdocs/sitemap;
        }

        location ~ "^/(rss\.php|rss)$" { 
          allow 127.0.0.1;
          allow 10.0.0.0/8;
          allow 172.16.0.0/12;
          allow 192.168.0.0/16;
          allow 121.0.29.0/24;
          allow 110.75.0.0/16;
          allow 220.181.68.0/24;
          deny all;
            location ~* ^(.+\.php)(.*)$ {
                fastcgi_pass        127.0.0.1:9090;
                fastcgi_index       index.php;
                fastcgi_hide_header X-Powered-By;
                fastcgi_intercept_errors on;
                fastcgi_buffers     32 32k;
                fastcgi_buffer_size 64k;
                fastcgi_busy_buffers_size 128k;
                fastcgi_param       SCRIPT_FILENAME $document_root$1;
                fastcgi_param       PATH_INFO   $2;
                include             fastcgi_params;
                fastcgi_param       SCRIPT_URI http://$server_name$uri;
                fastcgi_param       HTTP_REFERER $http_referer;
                fastcgi_param       HTTP_HOST $http_host;
                fastcgi_param       HTTP_ACCEPT $http_accept;
            }
        }

        location ~ /(tools|conf|misc)/ {
            allow 127.0.0.1/32;
            allow 10.1.0.0/16;
            allow 10.13.0.0/16;
            allow 172.23.51.17;
            allow 172.19.138.108;
            allow 121.0.29.0/24;
            allow 124.127.101.0/32;
	    allow 172.23.64.146;
	    allow 220.181.68.208;

            deny all;

            location ~* ^(.+\.php)(.*)$ {
                fastcgi_pass        127.0.0.1:9090;
                fastcgi_index       index.php;
                fastcgi_hide_header X-Powered-By;
                fastcgi_intercept_errors on;
                fastcgi_buffers     32 32k;
                fastcgi_buffer_size 64k;
                fastcgi_busy_buffers_size 128k;
                fastcgi_param       SCRIPT_FILENAME $document_root$1;
                fastcgi_param       PATH_INFO   $2;
                include             fastcgi_params;
                fastcgi_param       SCRIPT_URI http://$server_name$uri;
                fastcgi_param       HTTP_REFERER $http_referer;
                fastcgi_param       HTTP_HOST $http_host;
                fastcgi_param       HTTP_ACCEPT $http_accept;
            }
        }

        location ~* ^(.+\.php)(.*)$ {
            fastcgi_pass        127.0.0.1:9090;
            fastcgi_index       index.php;
            fastcgi_hide_header X-Powered-By;
            fastcgi_intercept_errors on;
            fastcgi_buffers     32 32k;
            fastcgi_buffer_size 64k;
            fastcgi_busy_buffers_size 128k;
            fastcgi_param       SCRIPT_FILENAME $document_root$1;
            fastcgi_param       PATH_INFO   $2;
            include             fastcgi_params;
            fastcgi_param       SCRIPT_URI http://$server_name$uri;
            fastcgi_param       HTTP_REFERER $http_referer;
            fastcgi_param       HTTP_HOST $http_host;
            fastcgi_param       HTTP_ACCEPT $http_accept;
        }

        location @check_code {
            rewrite ^  /deny.php last;
        }

        location @tc {
            hourglass_wait_time $time;
            hourglass_try_times 4;
        }

        location @punish {
            rewrite ^  /deny.php last;
        }
    }

